<?php
/*
    Class FirstInvoiceEmailClass

	Date: 2018-10-11

	capi

	Actions:
		-
	Private;

	Call:
	{

	}


*/

//require_once "MailerClass.inc";

class EmailClass extends ActionOpen {

	public function Run($data) {
		$actionMethod = 'action' . $data->_action;
		echo $this->$actionMethod($data);
	}

	public function actionFirstInvoice($data) {

		/*
		{
			"_group" : "Email",
			"_action" : "FirstInvoice",
			"_invoice_filename" : "12344420705-A22CF2BF-7E41-159F-B2C7-60289DD00E30.pdf",
			"email" : "bo.grus@yahoo.com"
		}

		*/

		// print_r($data); die('');

		$json =  json_encode($data);
		$result = $this->_RestApiCall($json);
		$invoiceObj = json_decode($result);

		// Get Installment Limit
		$paramInstallmentLimit = new stdClass();
		$paramInstallmentLimit->_group = "WebAppV4";
		$paramInstallmentLimit->_action = "GetInstallmentLimit";
		$resInstallmentLimit = json_decode($this->_RestApiCall(json_encode($paramInstallmentLimit)));
		$invoiceObj->installmentLimit = $resInstallmentLimit->installment_limit;
	

		// print_r($invoiceObj); die('');

		$toSubject = 'Faktura ' . $invoiceObj->company_name . ', ' . $invoiceObj->shop_name;

		$htmlInvoice = '';
		$htmlInvoice = '<div style="width:100%; max-width:500px; margin: 10px auto 0; border:1px solid #cccccc; border-radius: 8px; font-family: Helvetica,Arial,sans-serif, Verdana; padding:6px">';

		$htmlInvoice .= '<table style="width:100%; border-collapse:separate; border-spacing: 2px; font-size:14px;" >';
			$htmlInvoice .= '<tbody>';

				$htmlInvoice .= '<tr><td colspan="2" style="text-align: left;font-size:26px;">' . $invoiceObj->company_name . '</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2" style="text-align: left;font-size:12px;"><i>' . 'i samarbete med Turtle Pay' . '</i></td></tr>';
				$htmlInvoice .= '<tr><td colspan="2" style="text-align: left;font-size:18px;background-color: #ffffff">Faktura</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">&nbsp;</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2"><strong>Kund</strong></td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">' . $invoiceObj->name . '</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">' . $invoiceObj->address . '</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">' . $invoiceObj->postaddress  . '</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">&nbsp;</td></tr>';
				$htmlInvoice .= '<tr><td><strong>Utskriftsdatum</strong></td><td>' . $invoiceObj->date . '</td></tr>';
				$htmlInvoice .= '<tr><td><strong>Förfallodag</strong></td><td>' . $invoiceObj->duedate . '</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">&nbsp;</td></tr>';

				$htmlInvoice .= '<tr><td colspan="2" style="text-align:left; line-height: 200%;font-weight:bold; font-size:14px;background-color: #f4f4f4">Specifikation</td></tr>';
				$htmlInvoice .= '<tr><td>Transaktionsdatum</td><td>' . $invoiceObj->purchase_date . '</td></tr>';
				$htmlInvoice .= '<tr><td>&nbsp;</td><td>' . $invoiceObj->company_name . '</td></tr>';
				$htmlInvoice .= '<tr><td></td><td>' . $invoiceObj->shop_name . '</td></tr>';
				$htmlInvoice .= '<tr><td>Kvittoreferens</td><td>' . $invoiceObj->receipt_number . '</td></tr>';

				if ($invoiceObj->returnInvoice == "y") {
					$htmlInvoice .= '<tr><td>Köpesumma</td><td>' . $invoiceObj->prev_amount . '</td></tr>';
				} else {
					$htmlInvoice .= '<tr><td>Köpesumma</td><td>' . $invoiceObj->credit_amount . '</td></tr>';
				}

				if ($invoiceObj->returnInvoice == "y") {
					 $htmlInvoice .= '<tr><td>Returbelopp</td><td>-' . $invoiceObj->refund_amount . '</td></tr>';
				}
				if ($invoiceObj->refund_all == "y") {
					$htmlInvoice .= '<tr><td>Totalt</strong></td><td><strong>' . $invoiceObj->total . '</td></tr>';
					$htmlInvoice .= '<tr><td>OCR-nummer</td><td>' . $invoiceObj->ocrno . '</td></tr>';
				} else {
					if ($invoiceObj->start_fee > 0) {
						$htmlInvoice .= '<tr><td>Uppläggningsavgift</td><td>' . $invoiceObj->start_fee . '</td></tr>';
					}
					$htmlInvoice .= '<tr><td>Aviavgift</td><td>' . $invoiceObj->fee . '</td></tr>';
					$htmlInvoice .= '<tr><td><strong>Totalt (kr)</strong></td><td><strong>' . $invoiceObj->total . '</strong></td></tr>';
					$htmlInvoice .= '<tr><td>Betalningsmottagare</td><td>Turtle Pay AB</td></tr>';
					$htmlInvoice .= '<tr><td>Bankgiro</td><td>5258-0016</td></tr>';
					$htmlInvoice .= '<tr><td>OCR-nummer</td><td>' . $invoiceObj->ocrno . '</td></tr>';
					$htmlInvoice .= '<tr><td>Betalning oss tillhanda</td><td>' . $invoiceObj->duedate . '</td></tr>';
					$htmlInvoice .= '<tr><td colspan="2">&nbsp;</td></tr>';

					$totalValue = str_replace(',' , '', $invoiceObj->total);
					if ((float)$totalValue > $invoiceObj->installmentLimit) {
						$htmlInvoice .= '<tr><td colspan="2"><strong>' . "Ta't lugnt! Betala i din egen takt" . '</strong></td></tr>';

						$htmlInvoice .= '<tr><td colspan="2">Du kan istället betala valfritt belopp under ' . $invoiceObj->monthly_no . ' månader, </td></tr>';
						$htmlInvoice .= '<tr><td colspan="2">dock lägst <b>' . $invoiceObj->monthly_payment_total . ' kronor</b> på denna faktura senast ' . $invoiceObj->duedate . '</td></tr>';

						if ($invoiceObj->admin_fee > 0) {
							$htmlInvoice .= '<tr><td colspan="2"><i>(Räntefritt ' . $invoiceObj->grace_days . ' dagar, årsränta ' . $invoiceObj->interest . ' %,  adm.avg. ' . $invoiceObj->admin_fee . ' kr/mån)</i></td></tr>';
						} else {
							$htmlInvoice .= '<tr><td colspan="2"><i>(Räntefritt ' . $invoiceObj->grace_days . ' dagar, årsränta ' . $invoiceObj->interest . ' %)</i></td></tr>';
						}
					}
					$htmlInvoice .= '<tr><td colspan="2">Ange fakturans ocr-nummer vid inbetalningen.</td></tr>';
					$htmlInvoice .= '<tr><td colspan="2">Se villkor på följande länk: www.turtle-pay.com/villkor.</td></tr>';

					//$htmlInvoice .= '<tr><td colspan="2">Du kan istället betala valfritt månadsbelopp, dock lägst <strong>' . $invoiceObj->monthly_payment_total . ' kronor </strong> i 12 mån.</td></tr>';
					//$htmlInvoice .= '<tr><td colspan="2">Se villkor på följande länk: www.turtle-pay.com/villkor</td></tr>';
					//$htmlInvoice .= '<tr><td colspan="2">Första månadsbetalning oss tillhanda ' . $invoiceObj->duedate . '</td></tr>';
					//$htmlInvoice .= '<tr><td colspan="2">Ange fakturans ocr-nummer vid inbetalningen.</td></tr>';
				}
				$htmlInvoice .= '<tr><td colspan="2">&nbsp;</td></tr>';

				$htmlInvoice .= '<tr><td colspan="2">Turtle Pay AB, P.O. Box 24078, SE-104 50 Stockholm</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">Öppet vardagar 9-16, Telefon 08-80 62 20</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">info@turtle-pay.com</td></tr>';
				$htmlInvoice .= '<tr><td colspan="2">www.turtle-pay.com</td></tr>';
			$htmlInvoice .= '</tbody>';
		$htmlInvoice .= '</table>';

		require 'PHPMailerAutoload.php';
		$mail = new PHPMailer;
		$mail->isSMTP();

		$mail->Host = 'smtp.net.vmi.se';
        $mail->SMTPAuth = true;
        $mail->Username = 'turtlepaycom';
        $mail->Password = 'Kajk48Vaa'; // SegTp@2022';
        $mail->CharSet = 'UTF-8';
        $mail->Port = 465; // 465
        $mail->SMTPSecure = 'ssl';
		
		/*
		$mail->Host = 'mail.turtle-shop.se';
		$mail->Port = 465;
		$mail->SMTPSecure = 'ssl';
		$mail->SMTPAuth = true;
		$mail->Username = 'info@turtle-shop.se';
		$mail->Password = 'SegTp@2022';
		$mail->CharSet = 'UTF-8';
		*/


		$mail->From = 'info@turtle-pay.com';
		$mail->FromName = 'Turtle Pay';
		$mail->addReplyTo('info@turtle-pay.com');
		$mail->addAddress($invoiceObj->email, $invoiceObj->name);
		//$mail->addBCC('bo.grusell@turtle-pay.com');
		$mail->addBCC('info@turtle-shop.se');

		 // Add for notify invoice 20200913
		if ($invoiceObj->noti_invoice_on == 'y' ) {
			$mail->addCC($invoiceObj->noti_invoice_email);
		}
		
		$mail->isHTML(true);
		$mail->AddAttachment(FIRST_INVOICE_FOLDER . $invoiceObj->invoice_filename);
		if ($invoiceObj->has_attach == 'y') {
			if (sizeof($invoiceObj->attach_list) > 0) {
				for ($i=0; $i<sizeof($invoiceObj->attach_list); $i++) {
					$mail->AddAttachment(ATTACHMENT_FOLDER . $invoiceObj->attach_list[$i]->filename, $invoiceObj->attach_list[$i]->realname);
				}
			}
		}
		$mail->Subject = $toSubject;
		//$mailInvoice->Body = $this->htmlInvoice . '<div style="width:100%; padding:20px 0 10px 0; text-align:center"><a href="' . DOCVIEW . 'o/' . $this->orderid . '.html"' . '" style="font-size:20px; font-weight:bold; color: green">Skriv ut</a>';
		$mail->Body = $htmlInvoice;

		//print_r($mail); 
		$reply = new stdClass();
		if($mail->send()) {
			$reply->code = '1';
		} else {
			$reply->code = '0';
			$reply->denied_code = 'not-send-invoice';
			
		}
		return json_encode($reply);
	}
}
