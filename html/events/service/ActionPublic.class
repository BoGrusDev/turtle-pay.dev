<?php

class ActionPublic {

	protected $db;
	protected $url;

	public function __construct($DB_HOST, $DB_NAME, $DB_USER, $DB_PASS, $URL) {
		$this->Url = $URL;
		$this->db = new PDO('mysql:host=' . $DB_HOST . ';dbname=' . $DB_NAME . ';charset=utf8', $DB_USER , $DB_PASS);
	}

	function _Get($sql) {
		$stmt = $this->db->prepare($sql);
		$stmt->execute();
		if ($stmt->errorCode() == 0) {
			if($stmt->rowCount() > 0) {
				$result =  $stmt->fetch(PDO::FETCH_ASSOC);
				$result['code'] = "1";
				return $result;
			} else {
				$result =  array();
				$result['code'] = "0";
				return $result;
			}
		} else {
			$code = $stmt->errorCode() * -1;
			$result =  array();
			//$result['code'] = $code;
			$result['code'] = "0";
			return $result;
		}
	}

	function _Insert($table, $data) {

		$sql = 'INSERT INTO ' . $table . '(';
		$values = "";
		foreach($data as $key => $value) {
			if (substr($key, 0, 1) != '_') {
				$sql .= $key . ',';
				$values .= '"' . $value . '",';
			}
		}
		$sql = rtrim($sql, ",");
		$values = rtrim($values, ",");
		$sql .= ') VALUES (' . $values . ')';
		$stmt = $this->db->prepare($sql);

		//if ($table == "first_invoice") {
			 //echo $sql;
		 //}

		$stmt->execute();
		if ($stmt->errorCode() == '00000') {
			$result =  array();
			$result['code'] = "1";
			$result['id'] = $this->db->lastInsertId();
			return $result;
		} else {

			$code = $stmt->errorCode();
			if ($code == "23000") {
				$result =  array();
				$result['code'] = "0";
				$result['denied_code'] = "duplicated";
				return $result;
			} else {
				$result =  array();
				$result['code'] = "0";
				$result['denied_code'] = "error_when_insert";
				//return $result;
				echo $sql;
				print_r($stmt->errorInfo());
				$code = $stmt->errorCode() * -1;
				return $code;
			}
		}
	}

	function _Update($table, $primary_key, $id, $data) {

		$prepare = "UPDATE $table SET ";
		$paramArray = array();
		foreach($data as $key => $value) {
			if (substr($key, 0, 1) != '_') {
				$prepare .= $key . "='" . $value . "',";
			}
		}
		$prepare = rtrim($prepare, ",");

		$prepare .= " WHERE $primary_key = '" . $id . "'";
		$stmt = $this->db->prepare($prepare);
		$stmt->execute();
		if ($stmt->errorCode() == 0) {
			$result =  array();
			$result['code'] = "1";
			return $result;
		} else {
			$result =  array();
			$result['code'] = "0";
			//$result['error'] = $stmt->errorCode();
			return $result;
			//$code = $stmt->errorCode() * -1;
			//print_r($stmt);
			//return $code;
		}
	}

	function _RestApiCall($json) {
		$curl = curl_init($this->Url);
		curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "POST");
		curl_setopt($curl, CURLOPT_POSTFIELDS, $json);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl, CURLOPT_HTTPHEADER, array(
			'Content-Type: application/json',
			'Content-Length: ' . strlen($json))
		);
		$result = curl_exec($curl);
		curl_close($curl);
		return $result ;
	}

	function _BankIDAuth($data) {

		$reply = new StdClass();
		if (!isset($data->_bankid_personal_id_number)) {
			$reply->code = "0";
			$reply->denied_code = "bankid_personal_id_number_is_missing";
			return $reply;
			die('');
		}

		$json = '{"personalNumber":"' . $data->_bankid_personal_id_number . '", "endUserIp":"176.57.88.50"}';
		$curl = curl_init();
		curl_setopt( $curl, CURLOPT_URL, 'https://appapi2.bankid.com/rp/v5/auth');
		curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "POST");
		curl_setopt($curl, CURLOPT_POSTFIELDS, $json);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl, CURLOPT_HTTPHEADER, array(
			'Content-Type: application/json',
			'Content-Length: ' . strlen($json))
		);

		curl_setopt($curl, CURLOPT_CAINFO, 'bankid.ca.pem');
		//curl_setopt($curl, CURLOPT_SSLKEY, 'TurtlePayAB.key');
		//curl_setopt($curl, CURLOPT_SSLCERT, 'TurtlePayAB.pem');
		curl_setopt($curl, CURLOPT_SSLKEY, 'turtlepay2.key');
		curl_setopt($curl, CURLOPT_SSLCERT, 'turtlepay2.pem');
		curl_setopt($curl, CURLOPT_SSLCERTPASSWD, 'Fk&1618BKl@tp');
		curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);
		$result = curl_exec($curl);
		curl_close($curl);

		if(!$result) {
			$reply->code = "0";
 		   	$reply->denied_code = "bankid_problem";
		}
		else {
			$authObject = json_decode($result);
			if (isset($authObject->orderRef)) {
				$reply->code = "1";
				$reply->order_ref = $authObject->orderRef;
				$reply->auto_start_token = $authObject->autoStartToken;
				$reply->denied_code = "";
			}
			else if (isset($authObject->errorCode)) {
				$reply->code = "0";
				$reply->denied_code = $authObject->errorCode;
			}
			else {
				$reply->code = "0";
				$reply->denied_code = "bankid_problem";
			}
		}

		return $reply;
	}

	function _BankIDAuthCollect($data) {

		$reply = new StdClass();
		if (!isset($data->_order_ref)) {
			$reply->code = "0";
			$reply->denied_code = "order_ref_is_missing";
			return $reply;
			die('');
		}
		$json = '{"orderRef":"' . $data->_order_ref . '"}';
		$curlCheck = curl_init();
		curl_setopt( $curlCheck, CURLOPT_URL, 'https://appapi2.bankid.com/rp/v5/collect');
		curl_setopt($curlCheck, CURLOPT_CUSTOMREQUEST, "POST");
		curl_setopt($curlCheck, CURLOPT_POSTFIELDS, $json);
		curl_setopt($curlCheck, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curlCheck, CURLOPT_HTTPHEADER, array(
			'Content-Type: application/json',
			'Content-Length: ' . strlen($json))
		);
		curl_setopt($curlCheck, CURLOPT_CAINFO, 'bankid.ca.pem');
		curl_setopt($curlCheck, CURLOPT_SSLKEY, 'TurtlePayAB.key');
		curl_setopt($curlCheck, CURLOPT_SSLCERT, 'TurtlePayAB.pem');
		curl_setopt($curlCheck, CURLOPT_SSLKEY, 'turtlepay2.key');
		curl_setopt($curlCheck, CURLOPT_SSLCERT, 'turtlepay2.pem');
		curl_setopt($curlCheck, CURLOPT_SSLCERTPASSWD, 'Fk&1618BKl@tp');

		curl_setopt($curlCheck, CURLOPT_SSL_VERIFYHOST, 0);
		curl_setopt($curlCheck, CURLOPT_SSL_VERIFYPEER, 0);

		sleep(5);

		$status = false; // Set true when a complete, fail or inknown error occur
		while ($status== false) {

			$result = curl_exec($curlCheck);
			if(!$result) {
				$reply->code = "0";
	 		   	$reply->denied_code = "bankid_problem";
				return $reply;
				die('');
		   	}
			else {
				$collectObject = json_decode($result);
				if (isset($collectObject->errorCode)) {
					$reply->code = '0';
					$reply->denied_code = $collectObject->details;
					$status = true;
				} else {
					switch ($collectObject->status) {
						case 'pending':
							sleep(3);
							break;
						case 'failed':
							$reply->code = '0';
							$reply->denied_code = $collectObject->hintCode;
						 	$status = true;
							break;
						case 'complete':
							$reply->code = '1';
							$reply->name = $collectObject->completionData->user->name;
							$reply->givenName = $collectObject->completionData->user->givenName;
							$reply->surname = $collectObject->completionData->user->surname;
							$reply->ipAddress = $collectObject->completionData->device->ipAddress;
							$status = true;
							break;
						default:
							$reply->code = '0';
							$reply->denied_code = "bankid_problem";
							$status = true;
					}
				}
			}
		}
		return $reply;
	}

	function _BankIDCancel($data) {

		$reply = new StdClass();

		if (!isset($data->_order_ref)) {
			$reply->code = "0";
			$reply->denied_code = "order_ref_is_missing";
			return $reply;
			die('');
		}

		$json = '{"orderRef":"' . $data->_order_ref . '"}';
		$curl = curl_init();
		curl_setopt( $curl, CURLOPT_URL, 'https://appapi2.bankid.com/rp/v5/cancel');
		curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "POST");
		curl_setopt($curl, CURLOPT_POSTFIELDS, $json);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl, CURLOPT_HTTPHEADER, array(
			'Content-Type: application/json',
			'Content-Length: ' . strlen($json))
		);

		curl_setopt($curl, CURLOPT_CAINFO, 'bankid.ca.pem');
		curl_setopt($curl, CURLOPT_SSLKEY, 'TurtlePayAB.key');
		curl_setopt($curl, CURLOPT_SSLCERT, 'TurtlePayAB.pem');
		curl_setopt($curl, CURLOPT_SSLCERTPASSWD, 'Fk&1618BKl@tp');
		curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);

		$result = curl_exec($curl);
		curl_close($curl);

		if(!$result) {
		$reply->code = "0";
 		   $reply->denied_code = "bankid_problem";
 		   return $reply;
 		   die('');
		}

		$cancelObject = json_encode($result);

		$reply->code = "1";

		return $reply;
	}

	function _BankIDSignInit($data) {

		$reply = new StdClass();

		if (!isset($data->_bankid_personal_id_number)) {
			$reply->code = "0";
			$reply->denied_code = "bankid_personal_id_number_is_missing";
			return $reply;
			die('');
		}
		if (!isset($data->_bankid_text)) {
			$reply->code = "0";
			$reply->denied_code = "bankid_text_is_missing";
			return $reply;
			die('');
		}

		$signMessage = base64_encode($data->_bankid_text);
		$json = '{"personalNumber":"' . $data->_bankid_personal_id_number . '", "endUserIp":"176.57.88.50", "userVisibleData" : "' . $signMessage . '"}';
		$curl = curl_init();
		curl_setopt( $curl, CURLOPT_URL, 'https://appapi2.bankid.com/rp/v5/sign');
		//curl_setopt( $curl, CURLOPT_URL, 'https://appapi2.test.bankid.com/rp/v5/sign');
		curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "POST");
		curl_setopt($curl, CURLOPT_POSTFIELDS, $json);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl, CURLOPT_HTTPHEADER, array(
			'Content-Type: application/json',
			'Content-Length: ' . strlen($json))
		);
		//curl_setopt($curl, CURLOPT_CAINFO, 'appapi.test.bankid.com.pem');
		//curl_setopt($curl, CURLOPT_SSLCERT, '_test.pem');
		//curl_setopt($curl, CURLOPT_SSLCERTPASSWD, 'qwerty123');
		curl_setopt($curl, CURLOPT_CAINFO, 'bankid.ca.pem');
		curl_setopt($curl, CURLOPT_SSLKEY, 'TurtlePayAB.key');
		curl_setopt($curl, CURLOPT_SSLCERT, 'TurtlePayAB.pem');
		curl_setopt($curl, CURLOPT_SSLCERTPASSWD, 'Fk&1618BKl@tp');
		curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);
		$result = curl_exec($curl);
		curl_close($curl);

		if(!$result) {
			$reply->code = "0";
 		    $reply->denied_code = "bankid_problem";
 		   return $reply;
 		   die('');
		}

		$authObject = json_decode($result);
		if (isset($authObject->orderRef)) {
			$reply->code = "1";
			$reply->order_ref = $authObject->orderRef;
			$reply->denied_code = "";
			$reply->auto_start_token = $authObject->autoStartToken; // Till lögg för Web App

		}
		else if (isset($authObject->errorCode)) {
			$reply->code = "0";
			$reply->denied_code = $authObject->errorCode;
		}
		else {
			$reply->code = "0";
			$reply->denied_code = "bankid_problem";
		}

		return $reply;
	}

	function _BankIDSignCollect($data) {

	    $reply = new StdClass();

	    $json = '{"orderRef":"' . $data->_order_ref . '"}';
	    $curlCheck = curl_init();
	    curl_setopt( $curlCheck, CURLOPT_URL, 'https://appapi2.bankid.com/rp/v5/collect');
	    //curl_setopt( $curlCheck, CURLOPT_URL, 'https://appapi2.test.bankid.com/rp/v5/collect');
	    curl_setopt($curlCheck, CURLOPT_CUSTOMREQUEST, "POST");
	    curl_setopt($curlCheck, CURLOPT_POSTFIELDS, $json);
	    curl_setopt($curlCheck, CURLOPT_RETURNTRANSFER, 1);
	    curl_setopt($curlCheck, CURLOPT_HTTPHEADER, array(
	        'Content-Type: application/json',
	        'Content-Length: ' . strlen($json))
	    );
	    //curl_setopt($curlCheck, CURLOPT_CAINFO, 'appapi.test.bankid.com.pem');
	    //curl_setopt($curlCheck, CURLOPT_SSLCERT, '_test.pem');
	    //curl_setopt($curlCheck, CURLOPT_SSLCERTPASSWD, 'qwerty123');
	    curl_setopt($curlCheck, CURLOPT_CAINFO, 'bankid.ca.pem');
	    curl_setopt($curlCheck, CURLOPT_SSLKEY, 'TurtlePayAB.key');
	    curl_setopt($curlCheck, CURLOPT_SSLCERT, 'TurtlePayAB.pem');
	    curl_setopt($curlCheck, CURLOPT_SSLCERTPASSWD, 'Fk&1618BKl@tp');

	    curl_setopt($curlCheck, CURLOPT_SSL_VERIFYHOST, 0);
	    curl_setopt($curlCheck, CURLOPT_SSL_VERIFYPEER, 0);

	    $status = false; // Set true when a complete, fail or inknown error occur

	    $result = curl_exec($curlCheck);
	    if(!$result) {
			$reply->code = "0";
	  		$reply->denied_code = "bankid_problem";
	  		return $reply;
	  		die('');
	    }
	    else {
	        $collectObject = json_decode($result);
	        if (isset($collectObject->errorCode)){
	            $reply->status = 0;
	            $reply->denied_code = $collectObject->details;
	            $status = true;
	        } else {
	            $collectObject = json_decode($result);
	            switch ($collectObject->status) {
	                case 'pending':
	                    $reply->code = "2";
	                    $reply->denied_code = 'Pending';
	                    $status = true;
	                    break;
	                case 'failed':
	                    $reply->code = "0";
	                    $reply->denied_code = $collectObject->hintCode;
	                    $status = true;
	                    break;
	                case 'complete':
	                    $reply->code = "1";
	                    $reply->name = $collectObject->completionData->user->name;
	                    $reply->givenName = $collectObject->completionData->user->givenName;
	                    $reply->surname = $collectObject->completionData->user->surname;
	                    $reply->ipAddress = $collectObject->completionData->device->ipAddress;
	                    $reply->signature = $collectObject->completionData->signature;
	                    $reply->ocspResponse = $collectObject->completionData->ocspResponse;
	                    $status = true;
	                    break;
	                default:
	                    $reply->status = "0";
	                    $reply->denied_code = "bankid_problem";
	                    $status = true;
	                    //echo "Okänt fel";
	            }
	        }
	    }
	    //print_r($bankIdResult);
	    return $reply;
	}

	function _CreateToken(){
		// Return 2F8672B9-1BB8-2FFA-C56D-C5F8E8946FEF
		if (function_exists('com_create_guid')){
			return com_create_guid();
		}	else{
			mt_srand((double)microtime()*10000);//optional for php 4.2.0 and up.
			$charid = strtoupper(md5(uniqid(rand(), true)));
				/*
				$hyphen = chr(45);// "-"
				//$uuid = chr(123)// "{"
				$uuid =
					substr($charid, 0, 8).$hyphen
					.substr($charid, 8, 4).$hyphen
					.substr($charid,12, 4).$hyphen
					.substr($charid,16, 4).$hyphen
					.substr($charid,20,12);
				*/
			return $charid;
		}
	}

	function _CheckAge($personalNumber) {

	    $birthDate = substr($personalNumber, 0, 4) . "-" . substr($personalNumber, 4, 2) . "-" . substr($personalNumber, 6, 2);
	    $age= date("Y") - date("Y", strtotime($birthDate));
	    if ($age < 18) {
	        return false;
	    }
	    else {
	        return true;
	    }
	}

	function _CheckToken($token) {

		/*
			SELECT people_id, last_access FROM token_list WHERE token = 'BF0F487C0E34DC383D88823EDADCFCB0' AND status = 'w'

		*/

		$reply = new stdClass();
		$sql = "SELECT people_id, last_access FROM token_list WHERE token = '$token' AND status = 'w'";
		$result = $this->_get($sql);
		if ($result['code'] == "1") {
			// Check the date if it is expiere
			return $result['people_id'];
		}
		else {
			return false;
		}
	}


}
