<?php
/*
    Class ReportClass

	Date: 2018-10-10

	capi

	Actions:
		- DailyTakings

	Call:

	{
		"_group" : "Report",
		"_action" : "DailyTakings",
		"_date" : "2018-10-26",
		"_store_id" : "1",
		"_cr_id" : "1",
		"_email" : "bo.grus@yahoo.com"
	}

*/

class ReportClass extends ActionOpen {

	public function Run($data) {

		$actionMethod = 'action' . $data->_action;
		echo $this->$actionMethod($data);
	}

	private function actionDailyTakings($data) {

		if (date("Y-m-d") === $data->_date) {
			$reportTime = date("H:i");
		}
		else {
			$reportTime = "24:00";
		}
		$json =  json_encode($data);
		$result = $this->_RestApiCall($json);

		$reportObj = json_decode($result);
		$toSubject = 'Dagskassa ' . $reportObj->store_name . ', ' . $reportObj->company_name;
		$html = '<div style="width:100%; max-width:500px; margin: 10px auto 0; border:1px solid #cccccc; border-radius: 8px; font-family: Helvetica,Arial,sans-serif, Verdana; padding:6px">';

		$html .= '<table style="width:100%; border-collapse:separate; border-spacing: 2px; font-size:14px;" >';
			$html .= '<tbody>';
				$html .= '<tr><td colspan="2" style="text-align: left;font-size:26px;background-color: #ffffff">Dagskassa</td></tr>';
				$html .= '<tr><td colspan="2">&nbsp;</td></tr>';
				$html .= '<tr><td colspan="2" style="text-align: left;font-size:18px;">' . $reportObj->company_name . '</td></tr>';
				$html .= '<tr><td colspan="2" style="text-align: left;font-size:18px;">' . $reportObj->store_name . '</td></tr>';
				$html .= '<tr><td colspan="2">&nbsp;</td></tr>';
				//$html .= '<tr><td colspan="2" style="text-align:left; line-height: 200%;font-weight:bold; font-size:14px;background-color: #f4f4f4">Kassa 1</td></tr>';
				$html .= '<tr><td>Avstämningdatum:</td><td>' . $data->_date . '</td></tr>';
				$html .= '<tr><td>Avstämningstidpunkt:</td><td>' . $reportTime . '</td></tr>';
				$html .= '<tr><td colspan="2">&nbsp;</td></tr>';
				$html .= '<tr><td colspan="2" style="text-align: left;font-size:16px;"><strong>Kassa: ' . '1' . '</strong></td></tr>';
				$html .= '<tr><td>Försäljningsbelopp</td><td>' . $reportObj->sumInv . '</td></tr>';
				$html .= '<tr><td>Returbelopp</td><td>' . $reportObj->sumRef . '</td></tr>';
				$html .= '<tr><td><strong>Summa</strong></td><td><strong>' . $reportObj->sumTotal . '</strong></td></tr>';

			$html .= '</tbody>';
		$html .= '</table>';
		$html .= '</div>';

		//echo $html;

		//if (PRODUCTION) {
			require 'PHPMailerAutoload.php';
			$mail = new PHPMailer;
			$mail->isSMTP();
			//$mail->Host = 'postman.vmi.se';
			$mail->Host = 'smtp.gmail.com';
			$mail->SMTPAuth = true;
			//$mail->Username = 'order@bappnet.se';
			//$mail->Password = 'se0Jo';
			$mail->Username = 'info.turtlepay@gmail.com';
			$mail->Password = 'SegTp_2019';
			$mail->CharSet = 'UTF-8';
			//$mail->From = 'info@turtle-pay.com';
			$mail->FromName = 'TurtlePay';
			//$mail->addAddress($toEmail, $toName);
			//$mail->addAddress($invoiceObj->email, $invoiceObj->name);
			$mail->addAddress($data->_email);
			$mail->addBCC('bo.grusell@turtle-pay.com');
			$mail->addReplyTo('info@turtle-pay.com');
			$mail->isHTML(true);
			$mail->Subject = $toSubject;
			$mail->Body = $html;

			if(!$mail->send()) {
				//echo 'Problem sända Faktura.' . $mail->ErrorInfo;
				echo '{"code" : "0"}';
			} else {
				echo '{"code" : "1"}';
				echo $mail->ErrorInfo;
			}
		//}

		die();


	}

	private function actionBookingReport($data) {
		/*
				{
			"_group" : "Report",
			"_action" : "BookingReport",
			"_company_id" : "4",
			"_from_date" : "2019-01-01",
			"_to_date" : "2018-01-26"
		}
		*/



		$data->_action = 'BookingReportList';
		$json =  json_encode($data);
		//$list = json_decode($this->_RestApiCall($json));
		$list = json_decode($this->_RestApiCall($json));

		$data->_action = 'BookingReportBalance';
		$json =  json_encode($data);
		$result = json_decode($this->_RestApiCall($json));
		$balance = $result->balance;

		$data->_action = 'BookingReportCompany';
		$json =  json_encode($data);
		$companyObj = json_decode($this->_RestApiCall($json));

		$companyName = $companyObj->company_name;
		$email = $companyObj->email_report;
		$emailName = $companyObj->company_name;
		$bank_account = $companyObj->bank_account;

		$tr = '<tr style="font-size: 11px;">';
		$toSubject = 'Bokföringsorder';

		$html = '';
		$html .= '<div style="width:780px; margin: 10px auto 0; border:1px solid #cccccc; border-radius: 8px; font-family: Helvetica,Arial,sans-serif, Verdana; padding:6px">';
		$html .= '<h3>' . $companyName . '</h3>';
		$html .= '<p>Bankgiro: ' . $bank_account . '</p>';

		$html .= '<p style="font-size:12px">Se alla transaktioner under <a href="https://www.turtle-pay.com/logga-in">www.turtle-pay.com/logga-in</a>.</p>';

		//$html .= '<p>Er fordran(+)/Skuld(-)</h3>';

		$html .= '<table style="width:700px; padding-right: 8px; border-collapse:separate; border-spacing: 2px; font-size:14px;" >';
			$html .= '<tbody>';
			$html .= '<tr>';

			$html .= $tr; // '<tr>';

				$html .= '<th colspan="6" style="text-align: right; width:100%"><b>Er fordran(+)/Skuld(-)</b><br><br></th>';
			$html .= '</tr>';

				$html .= $tr; //'<tr>';
					$html .= '<th style="text-align: left; width:110px"><b>Datum</b></th>';
					$html .= '<th style="text-align: left; width:90px"><b>Typ</b></th>';
					$html .= '<th style="text-align: left;width:240px"><b>Kund</b></th>';
					$html .= '<th style="text-align: left; width:160px"><b>Kvittoref.</b></th>';
					$html .= '<th style="text-align: right; width:90px"><b>Belopp</b></th>';
					$html .= '<th style="text-align: right; width:100px"><b>Balans</b></th>';

				$html .= '</tr>';

				$html .= $tr; // '<tr>';
					$html .= '<td>' . $data->_from_date . '</td>';
					$html .= '<td>' . 'Ing.balans' . '</td>';
					$html .= '<td>' . "" . '</td>';
					$html .= '<td></td>';
					$html .= '<td></td>';
					$html .= '<td style="text-align: right">' . $balance * -1 . '</td>';

				$html .= '</tr>';

				//$transAvg = 0

				for ($i=0; $i < sizeof($list); $i++) {

					if ($list[$i]->trans_type == 'sales-reb') {
						$transAvg = $list[$i]->amount;
					}
					else {
						switch ($list[$i]->trans_type) {
							case 'new-credit':
								$text = "Fakturaköp";
								break;
							case 'vendor-fee':
								$text = "Trans.avg.";
								$list[$i]->amount = $transAvg + $list[$i]->amount;
								break;

							case 'vendor-pmt':
								$text = "Betalning";
								break;
							case 'refund':
								$text = "Retur";
								break;
							case 'vendor-pmt':
								$text = "Betalning";
								break;
							case 'interest':
								$text = "Ränta";
								break;
							case 'crediting':
								$text = "Kreditering";
								break;
							default:
								// code...
								break;
						}
						$html .= $tr; // '<tr>';
							$html .= '<td>' . $list[$i]->booking_date . '</td>';
							$html .= '<td>' . $text . '</td>';
							$html .= '<td>' . $list[$i]->first_name . ' ' . $list[$i]->last_name . '</td>';

							$html .= '<td>' . $list[$i]->receipt_number . '</td>';

							$amountText =  number_format($list[$i]->amount * -1, 2);
							$html .= '<td style="text-align: right">' . $amountText . '</td>';

							//$html .= '<td style="text-align: right">' . + $list[$i]['amount'] * -1 . '</td>';

							$balance = $balance + (float)$list[$i]->amount;
							$balanceText = number_format($balance * -1, 2);
							$html .= '<td style="text-align: right">' . $balanceText . '</td>';

						$html .= '</tr>';
					}
				}
			$html .= '</tbody>';
		$html .= '</table>';

		//echo $html; die('');

		require 'PHPMailerAutoload.php';
		$mail = new PHPMailer;
		$mail->isSMTP();
		//$mail->Host = 'postman.vmi.se';
		//$mail->Host = 'exchange.s.thehostingplatform.com';
		$mail->Host = 'smtp.gmail.com';
		$mail->SMTPAuth = true;
		$mail->Username = 'info.turtlepay@gmail.com';
		$mail->Password = 'SegTp_2019';

		$mail->CharSet = 'UTF-8';
		$mail->From = 'info@turtle-pay.com';
		$mail->FromName = 'TurtlePay';
		//$mail->addAddress("bo.grus@yahoo.com", "Bosse");
		//$mail->addAddress($invoiceObemail, $invoiceObj->name);
		//$mail->addAddress($email, $emailName);
		//$email ="stellan.forsberg@mondayrelations.se";
		
		if ($data->_company_id == '13') {
			$mail->addAddress('kimpanna@hotmail.com');
		}
		else {
			$mail->addAddress($email, $emailName );
		}
		
		
		// $mail->addAddress($email, $emailName );
		$mail->addBCC('bo.grusell@turtle-pay.com');
		$mail->addReplyTo('info@turtle-pay.com');
		$mail->isHTML(true);
		//$mail->AddAttachment(FIRST_INVOICE_FOLDER . $invoiceObj->invoice_filename);
		$mail->Subject = $toSubject;
		//$mail->Body = $this->htmlInvoice . '<div style="width:100%; padding:20px 0 10px 0; text-align:center"><a href="' . DOCVIEW . 'o/' . $this->orderid . '.html"' . '" style="font-size:20px; font-weight:bold; color: green">Skriv ut</a>';
		$mail->Body = $html;
		//$mail->Body = "Test";
		if(!$mail->send()) {
			$reply = new StdClass();
			$reply->code = '0';
			$reply->denied_code = 'cant-send-email';
			echo json_encode($reply);
		} else {
			$reply = new StdClass();
			$reply->code = '1';
			$reply->denied_code = 'OK';
			echo json_encode($reply);
		}
	}

}

/*

Reply:

*/
